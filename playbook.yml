- name: Provisioning graylog nodes
  hosts: "graylog"
  become: true

  tasks:

  - name: Set timezone to Europe/Kyiv
    timezone:
      name: "{{ graylog_timezone }}"
    become: yes

  - name: "Install Java"
    apt:
      update_cache: yes
      cache_valid_time: 3600
      name: "openjdk-8-jre"
      state: "latest"

- name: Install MongoDB
  hosts: "graylog"
  become: true
  vars:
    mongodb_version: "5.0"
    bind_ip: "0.0.0.0"
    repl_set_name: "rs0"
    authorization: "disabled"
  roles:
    - community.mongodb.mongodb_repository
    - community.mongodb.mongodb_mongod

  tasks:

  - name: "Start MongoDB"
    service:
      name: "mongod"
      state: "started"
      enabled: "yes"

- name: Configure MongoDB master node 
  hosts: "graylog01"
  become: true
  tasks:

  - name: "Install pip"
    apt:
      update_cache: yes
      cache_valid_time: 3600
      name:
      - "python3-pip"
      - "mongodb-clients"
      state: "latest"

  - name: "Install PyMongo"
    pip:
      name: "pymongo==3.12.0"
      state: "present"
    
  - name: Configure replicaset
    community.mongodb.mongodb_replicaset:
      login_host: "localhost"
      login_user: admin
      login_password: admin
      replica_set: "rs0"
      members:
      - host: "192.168.1.11:27017"
        priority: 1
      - host: "192.168.1.12:27017"
        priority: 0.5
      - host: "192.168.1.13:27017"
        priority: 0.5

- name: Install OpenSearch | Install necessary Packges
  hosts: "opensearch"
  become: true
  tasks:

  - name: OpenSearch Install | Import PGP key
    apt_key:
      url: https://artifacts.opensearch.org/publickeys/opensearch.pgp
      state: present

  - name: OpenSearch Install | Add OpenSearch 2.x repository
    apt_repository:
      repo: "deb [arch=amd64] https://artifacts.opensearch.org/releases/bundle/opensearch/2.x/apt stable main"
      validate_certs: false
      state: present

  - name: OpenSearch Install | Install packages
    apt:
      update_cache: yes
      name: "opensearch={{ opensearch_version }}"
      state: present
    environment:
      OPENSEARCH_INITIAL_ADMIN_PASSWORD: "{{ opensearch_password }}"

  - name: Set vm.max_map_count to 262144
    sysctl:
      name: vm.max_map_count
      value: 262144
      state: present
      sysctl_set: yes
  
  - name: Force systemd to reread configs 
    systemd:
      daemon_reload: true

  - name: Configuration for OpenSearch
    template:
      src: "{{ item.src }}"
      dest: "{{ item.dest }}"
    with_items:
      - {src: 'opensearch.j2', dest: '/etc/opensearch/opensearch.yml'}
      - {src: 'jvm.options.j2', dest: '/etc/opensearch/jvm.options'}
    notify: 
      - Restart Opensearch
  
  - name: Make sure opensearch is started
    ansible.builtin.service:
      name: opensearch
      state: started
      enabled: true 

  handlers:
    - name: Restart Opensearch
      service:
        name: opensearch
        state: restarted

- name: Install GrayLog
  hosts: "graylog"
  become: true
  tasks:

  - name: Ensure Graylog repository is downloaded
    get_url:
      url: "https://packages.graylog2.org/repo/packages/graylog-{{ graylog_version }}-repository_latest.deb"
      dest: "{{ ansible_user_dir }}/graylog-{{ graylog_version }}-repository_latest.deb"
      validate_certs: false
  
  - name: Install Graylog repository package
    apt:
      deb: "{{ ansible_user_dir }}/graylog-{{ graylog_version }}-repository_latest.deb"
      state: present
      update_cache: yes
      cache_valid_time: 3600


# - name: Install GrayLog
#   hosts: "graylog"
#   become: true
#   vars:
#     graylog_is_master: "{{ True if ansible_hostname == 'graylog01' else False }}"
#     graylog_version: 5.0
#     graylog_install_java: False
#     graylog_install_elasticsearch: False
#     graylog_install_mongodb: False
#     graylog_password_secret: "Devops228!" # Insert your own here. Generate with: pwgen -s 96 1
#     graylog_root_password_sha2: "Devops228!" # Insert your own root_password_sha2 here.
#     graylog_http_bind_address: "{{ ansible_default_ipv4.address }}:9000"
#     graylog_http_publish_uri: "http://{{ ansible_default_ipv4.address }}:9000/"
#     graylog_http_external_uri: "http://{{ ansible_default_ipv4.address }}:9000/"
#     graylog_opensearch_hosts: "http://192.168.1.11:9200,http://192.168.1.12:9200,http://192.168.1.13:9200"
#     graylog_mongodb_uri: "mongodb://192.168.1.11:27017,192.168.1.12:27017,192.168.1.13:27017/graylog?replicaSet=rs01"

#   roles:
#     - role: "graylog2.graylog"


